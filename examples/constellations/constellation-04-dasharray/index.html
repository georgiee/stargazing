<!DOCTYPE html>
<html lang="en" >

<head>
  <meta charset="UTF-8">
  <title>01 - Stargazing â€” Star Colors</title>
  <style>

  body {
    background-color: black;
    color: #fff;
    font-family: Arial, Helvetica, sans-serif;
    margin: 0;
  }

  .apply-offset {
    stroke-dashoffset: var(--offset, 0);
  }

  .translate-with-offset {
    transform: translate(calc(var(--offset, 0) * 1px), 0);
  }

  text {
    fill: white;
    font-size: 6px;
  }

  .path-with-dashes {
    stroke-dasharray: var(--dasharray, 0);
    stroke: hotpink;
    stroke-width: 2;
    fill: transparent;
  }

  [data-reveal] {
    visibility: hidden;
  }

  [data-reveal].show {
    visibility: visible;
  }

  svg {
    display: block;
    height: 100vh;
    width: 100vw;
  }

  [data-step] {
    visibility: hidden;
  }

  [data-step].show {
    visibility: visible;
  }



  </style>
</head>

<body>
<svg
  id='demosvg' preserveAspectRatio="xMidYMid meet" viewbox="-10 -10 240 120">

  <g transform="translate(0, 0)">
    <text id='amountOffset' y="0" x="0">dashoffset</text>
    <text id='amountArray' y="0" x="50">dasharray</text>

    <g transform="translate(0, 10)">
      <!-- line without offset animation -->

      <g transform="translate(0, 0)" data-step="1" class="group-01">
        <text>1. a nice line (100px)</text>

       <g transform="translate(0, 5)">
          <circle cx="0" cy = "0" r="2" fill=white></circle>
          <circle cx="100" cy = "0" r="2" fill=white></circle>
          <path class="path-with-dashes" d="M 0 0 L 100 0"></path>
       </g>
      </g>

      <!-- line extended -->
      <g transform="translate(0, 20)" data-step="2" class="group-02">
        <text>2. a nice line imagined a little longer (220px)</text>

        <g transform="translate(0, 5)">
            <circle cx="0" cy = "0" r="2" fill=white></circle>
            <circle cx="220" cy = "0" r="2" fill=white></circle>
            <path class="path-with-dashes" d="M 0 0 L 220 0"></path>
        </g>
      </g>

      <!-- line extended with sliding window -->
      <g transform="translate(0, 40)" data-step="3" class="group-03">
        <text>3. that line with a sliding window</text>
        <g transform="translate(0, 5)">

          <circle cx="0" cy = "0" r="2" fill=white></circle>
          <circle cx="220" cy = "0" r="2" fill=white></circle>
          <path class="path-with-dashes" d="M 0 0 L 220 0"></path>

          <g class="translate-with-offset">
            <circle cx="0" cy = "0" r="2" fill="yellow"></circle>
            <circle cx="100" cy = "0" r="2" fill="yellow"></circle>
            <rect width="100" height="6" y="-3" opacity="0.3" fill="yellow"></rect>
          </g>
        </g>
      </g>

      <!-- line with offset aligned with window-->
      <g transform="translate(0, 60)" data-step="4" class="group-04">
        <text>4. the sliding window alone</text>
        <g transform="translate(0, 5)">
          <g class="translate-with-offset">
            <rect width="100" height="6" y="-3" opacity="0.3" fill="yellow"></rect>
            <circle cx="0" cy = "0" r="2" fill=white></circle>
            <circle cx="100" cy = "0" r="2" fill=white></circle>
            <path class="apply-offset path-with-dashes" d="M 0 0 L 100 0"></path>
          </g>
        </g>
      </g>

      <!-- final line with offset animation -->
      <g transform="translate(0, 80)" data-step="5" class="group-05">
        <text>5. the final result</text>
        <g transform="translate(0, 5)">
          <circle cx="0" cy = "0" r="2" fill=white></circle>
          <circle cx="100" cy = "0" r="2" fill=white></circle>
          <path class="apply-offset path-with-dashes" d="M 0 0 L 100 0"></path>
        </g>
      </g>
    </g>
  </g>
</svg>

<!-- <input type="range" id='dashSize' min="0" maxx="150" value="10"> -->

<script>

  let offset = 0;
  let speed = 10;
  let playing = false;
  let intervalID = null;

  setDashOffset(0);

  function setDashArray(value) {
    demosvg.style.setProperty('--dasharray', value);
    amountArray.innerHTML = 'dasharray: '+ value;
  }
  function setDashOffset(value) {
    demosvg.style.setProperty('--offset', (value));
    amountOffset.innerHTML = 'dashoffset: ' +  Math.round(value);
  }

  const dashAnimation = {
    play() {
      setDashArray(100);
    },

    stop() {
      setDashArray(10);
    }
  }

  const offsetAnimation = {
    interval: null,

    play() {
      if(offsetAnimation.interval) {
        return;
      }
      offsetAnimation.interval = setInterval(() => {
        offset+=speed/20;
        setDashOffset(offset);
        if(offset >= 100 || offset <= 0) {
          speed *= -1;
        }
      }, 50);
    },

    stop() {
      clearInterval(offsetAnimation.interval);
      offsetAnimation.interval = null;

      setDashArray(10);
    }

  }


  const MAX_FRAGMENTS = 6;

  let counter = 0;

  let elements = [];
  collect();

  function start() {
    counter = 0;
    update(counter);

    setDashArray(10);
  }

  function stop() {
    counter = 0;
    update(counter);
  }

  function previous() {
    if(counter === 0) {
      counter = MAX_FRAGMENTS;
    }else {
    }

    counter--;
    update(counter);
  }

  function next() {
    counter++;
    update(counter);
  }

  const actions = [
    { index: 1, show: '.group-01' },
    { index: 2, show: '.group-02' },
    { index: 3, show: '.group-03' },
    { index: 4, run: offsetAnimation.play, stop: offsetAnimation.stop },
    { index: 4, show: '.group-04' },
    { index: 5, show: '.group-05' },
    { index: 6, run: dashAnimation.play, stop: dashAnimation.stop },
  ];

  function update(index) {
    const elements = document.querySelectorAll('[data-step]');
    const activeSet = actions.filter(action => action.index <= index);
    const inactiveSet = actions.filter(action => action.index > index);

    inactiveSet.forEach(action => {
      if(action.show) {
        const el = document.querySelector(action.show);
        el.classList.remove('show');
      }


      if(action.run && action.stop) {
        action.stop();
      }
    });

    activeSet.forEach(action => {
      if(action.show) {
        const el = document.querySelector(action.show);
        el.classList.add('show');
      }

      if(action.run) {
        action.run();
      }
    });
  }

  function collect() {
    const fragments = document.querySelectorAll('[data-step]');
    elements = new Array(...fragments);

    elements.sort((a, b) => {
      return parseInt(a.dataset.reveal) - parseInt(b.dataset.reveal);
    });


    elements.forEach(el => {
      el.classList.add('fragment');
    });

  }



  const urlParams = new URLSearchParams(window.location.search);
  const fullView = urlParams.has('full');

  // let us toggle the fully view by passing ?full to the iframe url
  if(fullView) {
    setDashArray(10);
    update(6);
  } else {

    window.addEventListener("message", ({data}) => {
    switch(data) {
      case 'slide:start': start(); break;
      case 'slide:stop': stop(); break;
      case 'next-topic': next(); break;
      case 'previous-topic': previous(); break;
    }
  });
  }
</script>
</body>

</html>
